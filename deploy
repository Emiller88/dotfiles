#!/usr/bin/env nix-shell
#! nix-shell -i bash -p git gnumake

set -e # bail if an error occurs
if [ $EUID -ne 0 ]; then
	echo >&2 "Must be run as root"
	exit 1
fi

USER=${USER:-emiller}
HOST=${1:-${HOST:-$(hostname)}}

DOTFILES="/home/$USER/.dotfiles"
if [ ! -d /etc/dotfiles ]; then
	git clone https://github.com/emiller88/dotfiles "$DOTFILES"
	chown -R $USER:users "$DOTFILES"
fi
ln -sf "$DOTFILES" /etc/dotfiles

if [ ! -d "$DOTFILES/hosts/$HOST" ]; then
	echo >&2 "No configuration exists for host '$HOST'"
	exit 1
fi
make -C "$DOTFILES" install
